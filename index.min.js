const e=e=>Array.isArray(e)?e:[e],t=e=>e.toString(16),r=(t,...r)=>r.reduce(((t,r)=>((t,r,a)=>{let l=e(r),p=e(a);return 0===l.length||0===p.length?l.concat(p):l.reduce(((e,t)=>(e.push(...p.map((e=>e+","+t))),e)),[])})(0,t,r)),[]),a=(e,t)=>e.replace(/(&|\|)/g,",").split(",").every(t.get),l=(e,t,r)=>{let l=(e=>t=>{let r,l=!1;for(;r=t.match(/\([^\(]+?\)/g);){for(let p=0,n=r.length;p<n;p++){let n=r[p],c=n.substr(1,n.length-2);if(l=a(c,e),!l)break;t=t.replace(n,e.add(c,"$"))}if(!l)break}return!(!l||!a(t,e))&&t})(r)("("+(e=>(t,r)=>t.replace(r,(t=>e.add(t,"#"))))(r)(e,t).replace(/\s/g,"").replace(/AND/g,"&").replace(/OR/g,"|")+")");return l||!1},p=(e,t)=>-1!==e.indexOf(t);export default(e,a)=>{const n=((e=t)=>{let r,a=0,l={};return{add:(t,p)=>(r=p+e(++a),l[r]=t,r),get:e=>l[e]}})(),c=e=>{const[t,a]=["|","&"].map((t=>p(e,t))),l=!p(e,"$"),s=t?e.split("|"):e;return l?s:t?e.split("|").map(c):a?r(e,...e.split("&").map(c)):c(n.get(e))};let s=l(e,a,n);return{isValid:!!s,results:s?[].concat(...c(s)).map((e=>{return(t=e.replace(/&/g,",").split(",")).sort(),t;var t})).map((e=>e.map((e=>n.get(e))))).map((e=>[...new Set(e)])):[]}};
